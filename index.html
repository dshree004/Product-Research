<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo-based Product Rater â€” Offline</title>
  <style>
    :root{--bg:#0b1020;--card:#111832;--muted:#aab3d4;--acc:#6ea8ff;--ok:#20c997;--warn:#ffca3a;--bad:#ff6b6b}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1020 50%,#0f1630);color:#eef2ff}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:clamp(22px,3vw,32px);margin:0}
    .badge{font-size:12px;color:#cbd5ff;background:#1b2448;border:1px solid #293469;border-radius:999px;padding:6px 10px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:420px 1fr}}
    .card{background:linear-gradient(180deg,#101936,#0e1530);border:1px solid #223066;border-radius:18px;box-shadow:0 8px 24px rgba(10,18,45,.35);padding:16px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type="text"],textarea,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a386b;background:#0c1330;color:#e8edff;outline:0}
    textarea{min-height:90px;resize:vertical}
    .hint{color:#93a1d3;font-size:12px;margin-top:6px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .stars{display:inline-flex;gap:4px}
    .star{font-size:22px;cursor:pointer;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
    .star[data-active="true"]{color:#ffd569;text-shadow:0 0 12px rgba(255,213,105,.35)}
    .btn{appearance:none;border:1px solid #3a4a86;background:#1a2550;color:#e8edff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.acc{border-color:#558cff;background:#1d2b66}
    .btn.warn{border-color:#9c7a00;background:#2f2808}
    .btn.danger{border-color:#ad2f2f;background:#3a0f13}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
    .item{background:linear-gradient(180deg,#0e1530,#0c1328);border:1px solid #223066;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;object-fit:cover;background:#0b132b}
    .item-body{padding:12px;display:grid;gap:6px}
    .muted{color:#9db0e0;font-size:12px}
    .rating{color:#ffd569}
    .pill{display:inline-block;background:#1b2448;border:1px solid #2a386b;border-radius:999px;padding:2px 8px;font-size:11px;color:#cbd5ff}
    .row-end{display:flex;justify-content:space-between;align-items:center}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a1128;border:1px dashed #2a386b;border-radius:10px;padding:8px 10px;color:#b8c6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ“· Product Rater (100% Offline)</h1>
      <span class="badge">No Google â€¢ Local-only â€¢ Single HTML file</span>
    </header>

    <div class="grid">
      <section class="card">
        <h2 style="margin-top:0">Add a rating</h2>
        <form id="form">
          <label for="name">Product name *</label>
          <input id="name" placeholder="e.g., Acme Coffee Beans 1kg" required />

          <div class="row">
            <div style="flex:1">
              <label for="category">Category</label>
              <input id="category" placeholder="e.g., Coffee" />
            </div>
            <div style="width:160px">
              <label for="sku">Code/SKU</label>
              <input id="sku" placeholder="optional" />
            </div>
          </div>

          <label>Rating *</label>
          <div class="stars" id="stars" aria-label="Choose rating from 1 to 5">
            <span class="star" role="button" data-val="1">â˜…</span>
            <span class="star" role="button" data-val="2">â˜…</span>
            <span class="star" role="button" data-val="3">â˜…</span>
            <span class="star" role="button" data-val="4">â˜…</span>
            <span class="star" role="button" data-val="5">â˜…</span>
          </div>
          <div class="hint">Tap a star (1â€“5). Higher is better.</div>

          <label for="photo">Photo *</label>
          <input id="photo" type="file" accept="image/*" capture="environment" />
          <div class="hint">On mobile, this opens the camera. Images are compressed before saving.</div>
          <img id="preview" alt="preview" style="display:none;margin-top:10px;max-width:100%;border-radius:12px;border:1px solid #223066" />

          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Taste, quality, price, etc."></textarea>

          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn acc" id="saveBtn" type="submit">Save</button>
          </div>
        </form>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Your entries</h2>
          <div class="toolbar">
            <input type="file" id="importJson" accept="application/json" style="display:none" />
            <button class="btn" id="importBtn" title="Import a JSON backup">Import JSON</button>
            <button class="btn" id="exportCsv">Export CSV</button>
            <button class="btn" id="exportJson">Export JSON</button>
            <button class="btn warn" id="clearAll">Clear all</button>
          </div>
        </div>
        <div id="list" class="list" style="margin-top:12px"></div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h3 style="margin-top:0">How it works</h3>
      <ul>
        <li><strong>Offline-first:</strong> Saves to your browser using IndexedDB. No servers.</li>
        <li><strong>Privacy:</strong> Photos & data stay on your device. You control backup/restore via JSON.</li>
        <li><strong>Portable:</strong> Open this file directly or host it on any static site (GitHub Pages / Netlify).</li>
      </ul>
      <p class="hint">Tip: Use <span class="code">Export JSON</span> routinely, and store it safely. You can restore later with <span class="code">Import JSON</span>.</p>
    </section>
  </div>

  <script>
  // ---------- Tiny IndexedDB helper ----------
  const idb = {
    db: null,
    open(){
      return new Promise((res, rej)=>{
        const req = indexedDB.open('productRaterDB', 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains('entries')){
            db.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
          }
        };
        req.onsuccess = () => { this.db = req.result; res(); };
        req.onerror = () => rej(req.error);
      });
    },
    tx(store, mode='readonly'){ return this.db.transaction(store, mode).objectStore(store); },
    add(store, val){ return new Promise((res, rej)=>{ const r=this.tx(store,'readwrite').add(val); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); },
    getAll(store){ return new Promise((res, rej)=>{ const r=this.tx(store).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); },
    put(store, val){ return new Promise((res, rej)=>{ const r=this.tx(store,'readwrite').put(val); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); },
    del(store, key){ return new Promise((res, rej)=>{ const r=this.tx(store,'readwrite').delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); },
    clear(store){ return new Promise((res, rej)=>{ const r=this.tx(store,'readwrite').clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
  };

  // ---------- DOM utilities ----------
  const $ = sel => document.querySelector(sel);
  const listEl = $('#list');
  const form = $('#form');
  const preview = $('#preview');
  const starsEl = $('#stars');
  let currentRating = 0;
  let editingId = null;

  // Star rating
  starsEl.addEventListener('mousemove', e => {
    if(!e.target.classList.contains('star')) return;
    highlight(parseInt(e.target.dataset.val,10));
  });
  starsEl.addEventListener('mouseleave', ()=> highlight(currentRating));
  starsEl.addEventListener('click', e => {
    if(!e.target.classList.contains('star')) return;
    currentRating = parseInt(e.target.dataset.val,10);
    highlight(currentRating);
  });
  function highlight(n){
    [...starsEl.children].forEach(s=> s.setAttribute('data-active', parseInt(s.dataset.val,10) <= n));
  }

  // Photo preview + compress
  $('#photo').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file){ preview.style.display='none'; return; }
    const dataUrl = await compressImage(file, 1280, 0.85);
    preview.src = dataUrl; preview.style.display = 'block';
    preview.dataset.dataurl = dataUrl;
  });

  async function compressImage(file, maxDim=1280, quality=0.85){
    const img = new Image();
    const reader = new FileReader();
    const dataUrl = await new Promise((res,rej)=>{ reader.onload=()=>res(reader.result); reader.onerror=rej; reader.readAsDataURL(file); });
    img.src = dataUrl;
    await img.decode();
    const scale = Math.min(1, maxDim/Math.max(img.width,img.height));
    const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
    const can = document.createElement('canvas');
    can.width=w; can.height=h;
    const ctx = can.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    return can.toDataURL('image/jpeg', quality);
  }

  // Save / Update
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = $('#name').value.trim();
    if(!name){ alert('Please enter product name'); return; }
    if(currentRating===0){ alert('Please choose a rating'); return; }
    const photoDataURL = preview.dataset.dataurl || '';
    if(!photoDataURL){ alert('Please add a photo'); return; }

    const entry = {
      id: editingId ?? undefined,
      name,
      category: $('#category').value.trim(),
      sku: $('#sku').value.trim(),
      rating: currentRating,
      notes: $('#notes').value.trim(),
      photoDataURL,
      ts: editingId ? (window.__existingTS || Date.now()) : Date.now()
    };

    await idb.open();
    if(editingId){ await idb.put('entries', entry); } else { entry.id = await idb.add('entries', entry); }

    clearForm();
    await render();
  });

  function clearForm(){
    form.reset();
    preview.removeAttribute('data-dataurl');
    preview.style.display='none';
    preview.src='';
    currentRating = 0; highlight(0); editingId=null; delete window.__existingTS;
  }

  async function render(){
    await idb.open();
    const items = (await idb.getAll('entries')).sort((a,b)=>b.ts-a.ts);
    listEl.innerHTML = items.map(it=> cardHtml(it)).join('');
    // bind events
    listEl.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = parseInt(btn.closest('.item').dataset.id,10);
        const action = btn.dataset.action;
        if(action==='delete'){
          await idb.del('entries', id); await render();
        } else if(action==='edit'){
          const it = items.find(x=>x.id===id);
          $('#name').value = it.name; $('#category').value=it.category||''; $('#sku').value=it.sku||''; $('#notes').value=it.notes||'';
          currentRating = it.rating; highlight(currentRating);
          preview.src = it.photoDataURL; preview.style.display='block'; preview.dataset.dataurl = it.photoDataURL;
          editingId = it.id; window.__existingTS = it.ts;
          window.scrollTo({top:0,behavior:'smooth'});
        } else if(action==='download'){
          const a = document.createElement('a'); a.href = btn.dataset.href; a.download = (items.find(x=>x.id===id).name||'photo')+'.jpg'; a.click();
        }
      });
    });
  }

  function cardHtml(it){
    const date = new Date(it.ts).toLocaleString();
    return `
    <article class="item" data-id="${it.id}">
      <img class="thumb" src="${it.photoDataURL}" alt="${escapeHtml(it.name)}" />
      <div class="item-body">
        <div class="row-end"><strong>${escapeHtml(it.name)}</strong> <span class="pill">${escapeHtml(it.category||'')}</span></div>
        <div class="muted">${date}${it.sku?` â€¢ SKU ${escapeHtml(it.sku)}`:''}</div>
        <div class="rating" aria-label="rating">${'â˜…'.repeat(it.rating)}</div>
        ${it.notes?`<div class="muted">${escapeHtml(it.notes)}</div>`:''}
        <div class="toolbar" style="margin-top:6px">
          <button class="btn" data-action="edit">Edit</button>
          <button class="btn danger" data-action="delete">Delete</button>
          <button class="btn" data-action="download" data-href="${it.photoDataURL}">Download photo</button>
        </div>
      </div>
    </article>`
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"'] /g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]) ); }

  // Exporters
  $('#exportJson').addEventListener('click', async ()=>{
    await idb.open();
    const items = await idb.getAll('entries');
    const blob = new Blob([JSON.stringify(items,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download='product_ratings.json'; a.click(); URL.revokeObjectURL(url);
  });

  $('#exportCsv').addEventListener('click', async ()=>{
    await idb.open(); const items = await idb.getAll('entries');
    const headers = ['timestamp','name','category','sku','rating','notes'];
    const rows = items.map(x=> [new Date(x.ts).toISOString(), q(x.name), q(x.category), q(x.sku), x.rating, q(x.notes)].join(','));
    const csv = [headers.join(','), ...rows].join('
');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download='product_ratings.csv'; a.click(); URL.revokeObjectURL(url);
    function q(s){ s = (s||'').replaceAll('"','""'); return `"${s}"`; }
  });

  // Import JSON
  const importInput = document.getElementById('importJson');
  document.getElementById('importBtn').addEventListener('click', ()=> importInput.click());
  importInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text();
      const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('Invalid file');
      await idb.open();
      // Simple merge: assign new IDs and keep existing
      for(const it of arr){
        const rec = { ...it, id: undefined };
        await idb.add('entries', rec);
      }
      await render();
      alert('Imported successfully');
    }catch(err){
      alert('Import failed: '+err.message);
    }finally{
      e.target.value='';
    }
  });

  $('#clearAll').addEventListener('click', async ()=>{
    if(!confirm('Delete ALL entries?')) return;
    await idb.open(); await idb.clear('entries'); await render();
  });

  // Init
  (async()=>{ await idb.open(); await render(); })();
  </script>
</body>
</html>
