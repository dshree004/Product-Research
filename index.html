<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Rater (Offline)</title>
  <style>
    body {
      font-family: Inter, Arial, sans-serif;
      background: #0b1020;
      color: #eef;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { text-align: center; }
    form {
      background: #111832;
      border-radius: 16px;
      padding: 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    input, textarea, button {
      width: 100%;
      margin-top: 8px;
      margin-bottom: 16px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #223066;
      background: #0b132b;
      color: #eef;
    }
    label { font-weight: 600; display: block; margin-top: 8px; }
    .rating-group { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .rating-pill { text-align: center; padding: 8px 0; border-radius: 8px; background:#192040; cursor:pointer; }
    .rating-group input[type="radio"]{ display:none; }
    .rating-group input:checked + .rating-pill{ background:#4473ff; color:#fff; }
    .preview-thumb {
      width: 120px;
      height: 120px;
      object-fit: cover;
      display: none;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #223066;
    }
    .entries {
      margin-top: 24px;
      width: 100%;
      max-width: 420px;
      background: #111832;
      border-radius: 16px;
      padding: 20px;
    }
    .entry {
      border-bottom: 1px solid #223066;
      padding-bottom: 10px;
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      background: #0b132b;
      display:flex;align-items:center;justify-content:center;font-size:12px;color:#9db0e0;
    }
  </style>
</head>
<body>
  <h1>ðŸ“· Product Rater</h1>

  <form id="rater-form">
    <label>Product name *</label>
    <input id="name" type="text" required />

    <label>Category</label>
    <input id="category" type="text" />

    <label>Code / SKU</label>
    <input id="sku" type="text" />

    <label>Rating *</label>
    <div class="rating-group">
      <input type="radio" id="r1" name="rating" value="1"><label class="rating-pill" for="r1">1</label>
      <input type="radio" id="r2" name="rating" value="2"><label class="rating-pill" for="r2">2</label>
      <input type="radio" id="r3" name="rating" value="3"><label class="rating-pill" for="r3">3</label>
      <input type="radio" id="r4" name="rating" value="4"><label class="rating-pill" for="r4">4</label>
      <input type="radio" id="r5" name="rating" value="5"><label class="rating-pill" for="r5">5</label>
    </div>

    <label>Photo <span style="font-size:smaller">(optional)</span></label>
    <input id="photo" type="file" accept="image/*" capture="environment" />
    <img id="preview" class="preview-thumb" alt="preview" />

    <label>Notes</label>
    <textarea id="notes" rows="3"></textarea>

    <button type="submit" id="saveBtn">Save</button>
  </form>

  <div class="entries" id="entries">
    <h2>Your entries</h2>
    <div id="list"></div>
  </div>

  <script>
    let db;
    const preview = document.getElementById("preview");

    function getSelectedRating() {
      const r = document.querySelector('input[name="rating"]:checked');
      return r ? parseInt(r.value, 10) : 0;
    }

    async function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open("ProductRaterDB", 1);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if(!db.objectStoreNames.contains("entries")){
            db.createObjectStore("entries", { keyPath: "id", autoIncrement: true });
          }
        };
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    async function getAllEntries() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction("entries", "readonly");
        const store = tx.objectStore("entries");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    async function renderEntries() {
      const list = document.getElementById("list");
      list.innerHTML = "";
      const entries = await getAllEntries();
      if (!entries.length) {
        list.innerHTML = "<p>No entries yet. Add one above.</p>";
        return;
      }
      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";
        const thumb = e.photo
          ? `<img class='thumb' src='${e.photo}' alt='${escapeHtml(e.name)}' />`
          : `<div class='thumb'>No photo</div>`;
        div.innerHTML = `${thumb}<div><b>${escapeHtml(e.name)}</b><br>Rating: ${e.rating}/5<br>${escapeHtml(e.notes || "")}</div>`;
        list.appendChild(div);
      });
    }

    function escapeHtml(s){return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

    document.getElementById("photo").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) { preview.style.display = "none"; delete preview.dataset.dataurl; return; }
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        preview.style.display = "block";
        preview.dataset.dataurl = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("rater-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const rating = getSelectedRating();
      if (!name || rating === 0) {
        alert("Please enter a product name and select a rating.");
        return;
      }
      const entry = {
        name,
        category: document.getElementById("category").value,
        sku: document.getElementById("sku").value,
        rating,
        notes: document.getElementById("notes").value,
        photo: preview.dataset?.dataurl || ""
      };

      try{
        if(!db) db = await openDB();
        const tx = db.transaction("entries", "readwrite");
        const store = tx.objectStore("entries");
        const req = store.add(entry);
        req.onsuccess = () => {
          document.getElementById("rater-form").reset();
          preview.style.display = "none";
          delete preview.dataset.dataurl;
          renderEntries();
          alert("âœ… Saved");
        };
        req.onerror = () => {
          console.error(req.error);
          alert("Could not save entry: " + (req.error?.message || req.error));
        };
      }catch(err){
        console.error(err);
        alert("Database error: " + err.message);
      }
    });

    window.onload = async () => {
      db = await openDB();
      renderEntries();
    };
  </script>
</body>
</html>
