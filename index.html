<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Rater â€” Offline PWA</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="/Product-Research/manifest.webmanifest">
  <link rel="icon" href="/Product-Research/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/Product-Research/icons/icon-192.png">
  <style>
    :root{--bg:#0b1020;--card:#111832;--muted:#aab3d4;--acc:#6ea8ff}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1020 50%,#0f1630);color:#eef2ff}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    h1{margin:0;font-size:clamp(22px,3vw,30px)}
    .badge{font-size:12px;color:#cbd5ff;background:#1b2448;border:1px solid #293469;border-radius:999px;padding:6px 10px}
    .card{background:linear-gradient(180deg,#101936,#0e1530);border:1px solid #223066;border-radius:16px;box-shadow:0 8px 24px rgba(10,18,45,.35);padding:14px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a386b;background:#0c1330;color:#e8edff;outline:0}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .stars{display:inline-flex;gap:4px}
    .star{font-size:22px;cursor:pointer;user-select:none;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
    .star[data-active="true"]{color:#ffd569;text-shadow:0 0 12px rgba(255,213,105,.35)}
    .btn{appearance:none;border:1px solid #3a4a86;background:#1a2550;color:#e8edff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.warn{border-color:#9c7a00;background:#2f2808}
    .btn.danger{border-color:#ad2f2f;background:#3a0f13}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px}
    .empty{padding:12px;border:1px dashed #2a386b;border-radius:12px;color:#aab3d4;background:#0a1128}
    .item{background:linear-gradient(180deg,#0e1530,#0c1328);border:1px solid #223066;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;object-fit:cover;background:#0b132b}
    .item-body{padding:10px;display:grid;gap:6px}
    .muted{color:#9db0e0;font-size:12px}
    .pill{display:inline-block;background:#1b2448;border:1px solid #2a386b;border-radius:999px;padding:2px 8px;font-size:11px;color:#cbd5ff}
    .rating{color:#ffd569}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0e1530;border:1px solid #2a386b;border-radius:999px;padding:10px 14px;opacity:0;pointer-events:none;transition:opacity .2s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>ðŸ“· Product Rater</h1>
      <span class="badge">Offline â€¢ Installable â€¢ Single file</span>
    </div>

    <section class="card" style="margin-top:14px">
      <h2 style="margin:4px 0 8px">Add a rating</h2>
      <form id="form">
        <label for="name">Product name *</label>
        <input id="name" placeholder="e.g., Acme Coffee Beans 1kg" required />

        <div class="row">
          <div style="flex:1;min-width:180px">
            <label for="category">Category</label>
            <input id="category" placeholder="e.g., Coffee" />
          </div>
          <div style="width:160px">
            <label for="sku">Code/SKU</label>
            <input id="sku" placeholder="optional" />
          </div>
        </div>

        <label>Rating *</label>
        <div class="stars" id="stars" aria-label="Choose rating from 1 to 5">
          <span class="star" role="button" data-val="1">â˜…</span>
          <span class="star" role="button" data-val="2">â˜…</span>
          <span class="star" role="button" data-val="3">â˜…</span>
          <span class="star" role="button" data-val="4">â˜…</span>
          <span class="star" role="button" data-val="5">â˜…</span>
        </div>
        <div class="muted" style="margin-top:4px">Tap a star (1â€“5). Higher is better.</div>

        <label for="photo" style="margin-top:10px">Photo *</label>
        <input id="photo" type="file" accept="image/*" capture="environment" />
        <img id="preview" alt="preview" style="display:none;margin-top:10px;max-width:100%;border-radius:12px;border:1px solid #223066" />

        <label for="notes" style="margin-top:10px">Notes</label>
        <textarea id="notes" placeholder="Taste, quality, price, etc."></textarea>

        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="muted">Required: name, rating, photo</div>
          <div class="toolbar">
            <button type="button" class="btn" id="demoBtn">Add demo item</button>
            <button class="btn" id="saveBtn" type="submit">Save</button>
          </div>
        </div>
      </form>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:4px 0">Your entries</h2>
        <div class="toolbar">
          <input type="file" id="importJson" accept="application/json" style="display:none" />
          <button class="btn" id="importBtn">Import JSON</button>
          <button class="btn" id="exportCsv">Export CSV</button>
          <button class="btn" id="exportJson">Export JSON</button>
          <button class="btn warn" id="clearAll">Clear all</button>
        </div>
      </div>
      <div id="list" class="list" style="margin-top:10px"></div>
      <div id="emptyState" class="empty" style="display:none;margin-top:10px">No entries yet. Add one above. If Save doesn't show it, ensure you've picked a <strong>star rating</strong> and <strong>added a photo</strong>.</div>
    </section>
  </div>

  <div id="toast" class="toast">âœ… Saved</div>

  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/Product-Research/sw.js").catch(()=>{});
    });
  }

  const idb = {
    db:null,
    open(){
      return new Promise((res,rej)=>{
        const req=indexedDB.open('productRaterDB',1);
        req.onupgradeneeded=()=>{
          const db=req.result;
          if(!db.objectStoreNames.contains('entries')) db.createObjectStore('entries',{keyPath:'id',autoIncrement:true});
        };
        req.onsuccess=()=>{this.db=req.result;res();};
        req.onerror=()=>rej(req.error);
      });
    },
    tx(s,m='readonly'){return this.db.transaction(s,m).objectStore(s)},
    add(s,v){return new Promise((res,rej)=>{const r=this.tx(s,'readwrite').add(v);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});},
    getAll(s){return new Promise((res,rej)=>{const r=this.tx(s).getAll();r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});},
    put(s,v){return new Promise((res,rej)=>{const r=this.tx(s,'readwrite').put(v);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});},
    del(s,k){return new Promise((res,rej)=>{const r=this.tx(s,'readwrite').delete(k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});},
    clear(s){return new Promise((res,rej)=>{const r=this.tx(s,'readwrite').clear();r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});}
  };

  const $ = s=>document.querySelector(s);
  const listEl = $('#list');
  const emptyEl = $('#emptyState');
  const form = $('#form');
  const preview = $('#preview');
  const starsEl = $('#stars');
  const toast = $('#toast');
  let currentRating = 0; let editingId = null;

  starsEl.addEventListener('click', e=>{
    if(!e.target.classList.contains('star')) return;
    currentRating = parseInt(e.target.dataset.val,10) || 0;
    highlight(currentRating);
  });
  starsEl.addEventListener('mousemove', e=>{
    if(!e.target.classList.contains('star')) return; highlight(parseInt(e.target.dataset.val,10)||0);
  });
  starsEl.addEventListener('mouseleave', ()=> highlight(currentRating));
  function highlight(n){ [...starsEl.children].forEach(s=> s.setAttribute('data-active', (+s.dataset.val)<=n)); }

  $('#photo').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file){ preview.style.display='none'; preview.removeAttribute('data-dataurl'); return; }
    try { const dataUrl = await compressImage(file,1280,0.85); preview.src=dataUrl; preview.style.display='block'; preview.dataset.dataurl=dataUrl; }
    catch(err){ alert('Could not read photo: '+err.message); }
  });
  async function compressImage(file,maxDim=1280,quality=0.85){
    const img=new Image(); const reader=new FileReader();
    const dataUrl = await new Promise((res,rej)=>{ reader.onload=()=>res(reader.result); reader.onerror=rej; reader.readAsDataURL(file); });
    img.src=dataUrl; await img.decode();
    const scale=Math.min(1,maxDim/Math.max(img.width,img.height));
    const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
    const can=document.createElement('canvas'); can.width=w; can.height=h; const ctx=can.getContext('2d'); ctx.drawImage(img,0,0,w,h);
    return can.toDataURL('image/jpeg',quality);
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = $('#name').value.trim();
    if(!name){ alert('Please enter product name'); return; }
    if(currentRating===0){ alert('Please choose a rating'); return; }
    const photoDataURL = preview.dataset.dataurl || '';
    if(!photoDataURL){ alert('Please add a photo'); return; }
    const entry = { id: editingId ?? undefined, name, category:$('#category').value.trim(), sku:$('#sku').value.trim(), rating:currentRating, notes:$('#notes').value.trim(), photoDataURL, ts: editingId ? (window.__existingTS||Date.now()) : Date.now() };
    await idb.open(); if(editingId){ await idb.put('entries',entry); } else { entry.id = await idb.add('entries',entry); }
    clearForm(); await render(); showToast('âœ… Saved');
  });

  function clearForm(){ form.reset(); preview.removeAttribute('data-dataurl'); preview.style.display='none'; preview.src=''; currentRating=0; highlight(0); editingId=null; delete window.__existingTS; }

  async function render(){
    await idb.open(); const items=(await idb.getAll('entries')).sort((a,b)=>b.ts-a.ts);
    emptyEl.style.display = items.length? 'none':'block';
    listEl.innerHTML = items.map(cardHtml).join('');
    listEl.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id=+btn.closest('.item').dataset.id; const action=btn.dataset.action;
        const it = (await idb.getAll('entries')).find(x=>x.id===id);
        if(action==='delete'){ await idb.del('entries',id); await render(); }
        else if(action==='edit' && it){ $('#name').value=it.name; $('#category').value=it.category||''; $('#sku').value=it.sku||''; $('#notes').value=it.notes||''; currentRating=it.rating; highlight(currentRating); preview.src=it.photoDataURL; preview.style.display='block'; preview.dataset.dataurl=it.photoDataURL; editingId=it.id; window.__existingTS=it.ts; window.scrollTo({top:0,behavior:'smooth'}); }
        else if(action==='download' && it){ const a=document.createElement('a'); a.href=it.photoDataURL; a.download=(it.name||'photo')+'.jpg'; a.click(); }
      });
    });
  }

  function cardHtml(it){
    const date=new Date(it.ts).toLocaleString();
    return `<article class="item" data-id="${it.id}">
      <img class="thumb" src="${it.photoDataURL}" alt="${escapeHtml(it.name)}" />
      <div class="item-body">
        <div class="row" style="justify-content:space-between"><strong>${escapeHtml(it.name)}</strong> <span class="pill">${escapeHtml(it.category||'')}</span></div>
        <div class="muted">${date}${it.sku?` â€¢ SKU ${escapeHtml(it.sku)}`:''}</div>
        <div class="rating">${'â˜…'.repeat(it.rating)}</div>
        ${it.notes?`<div class="muted">${escapeHtml(it.notes)}</div>`:''}
        <div class="toolbar" style="margin-top:6px"><button class="btn" data-action="edit">Edit</button><button class="btn danger" data-action="delete">Delete</button><button class="btn" data-action="download">Download photo</button></div>
      </div>
    </article>`;
  }

  function escapeHtml(s){return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));}
  function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1200); }

  const importInput = document.getElementById('importJson');
  document.getElementById('importBtn').addEventListener('click', ()=> importInput.click());
  importInput.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; try{ const text=await f.text(); const arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error('Invalid JSON'); await idb.open(); for(const it of arr){ const rec={...it,id:undefined}; await idb.add('entries',rec);} await render(); showToast('âœ… Imported'); }catch(err){ alert('Import failed: '+err.message);} finally{ e.target.value='';
