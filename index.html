<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ðŸ“¸ Product Rater</title>

<!-- PWA -->
<link rel="manifest" href="/Product-Research/manifest.webmanifest">
<link rel="icon" href="/Product-Research/icons/icon-192.png">
<link rel="apple-touch-icon" href="/Product-Research/icons/icon-192.png">
<meta name="theme-color" content="#0b1020">

<!-- ZIP builder (CDN). If you prefer local, upload jszip.min.js to your repo and change the src. -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  :root{--bg:#0b1020;--card:#111832;--mut:#aab3d4;--acc:#6ea8ff;--border:#223066;--gutter:16px}
  *,*::before,*::after{ box-sizing:border-box; }
  html,body{height:100%}
  body{
    font-family:Inter,Arial,sans-serif;background:var(--bg);color:#eef;margin:0;
    padding:20px;
    padding-left:max(20px,env(safe-area-inset-left));
    padding-right:max(20px,env(safe-area-inset-right));
    padding-bottom:max(20px,env(safe-area-inset-bottom));
    overflow-x:hidden;
  }
  h1{color:#8ec5ff;text-align:center;margin:0 0 16px}

  .card{
    background:#111832;border:1px solid var(--border);border-radius:16px;
    box-shadow:0 10px 30px rgba(10,18,45,.35);
    max-width:720px;margin:0 auto 16px;padding:var(--gutter) calc(var(--gutter) + 8px);
    overflow:visible;
  }

  /* form */
  #form{ display:grid; gap:12px; }
  label{font-weight:600;display:block}
  input,textarea,button{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
    background:#1b2444;color:#eef;
  }
  textarea{min-height:90px}
  button{background:#1a55ff;border:none;cursor:pointer}
  button:hover{background:#3a6eff}
  button:disabled{opacity:.6;cursor:not-allowed}

  /* rating */
  .rating{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .rating input{display:none}
  .rating label{background:#192040;text-align:center;padding:10px;border-radius:10px;cursor:pointer}
  .rating input:checked+label{background:#4473ff;color:#fff}

  /* media */
  .preview{width:120px;height:120px;object-fit:cover;border-radius:12px;border:1px solid var(--border);display:none}
  .thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;background:#0b132b}

  /* list/table */
  .table-wrap{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:0 8px}
  .table{width:100%;border-collapse:collapse;table-layout:fixed}
  .table th,.table td{border-top:1px solid var(--border);padding:10px;text-align:left;vertical-align:top;word-wrap:break-word}
  .table th{color:#a9c7ff;font-weight:700}
  .muted{opacity:.8}

  /* actions */
  .actions{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin:8px 0 0}
  .btn-secondary{background:#23306b}
  .btn-secondary:hover{background:#2c3a7f}

  /* mobile cards */
  .cards{display:none;gap:10px}
  .entry-card{
    display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;
    background:#0c1330;border:1px solid var(--border);border-radius:14px;padding:10px
  }
  .entry-card .title{font-weight:700;color:#cfe1ff}
  .entry-card .meta{font-size:13px;color:#aab3d4}
  .entry-card .pill{display:inline-block;background:#1b2448;border:1px solid #2a386b;border-radius:999px;padding:2px 8px;font-size:12px;color:#cbd5ff;margin-right:6px}

  @media (max-width: 640px){
    :root{ --gutter:18px; }
    .card{max-width: 100%;}
    .rating{grid-template-columns: repeat(5, minmax(44px,1fr))}
    .table-wrap{display:none}
    .cards{display:grid}
  }
</style>
</head>
<body>
  <h1>ðŸ“¸ Product Rater</h1>

  <div class="card">
    <form id="form">
      <label>Product name *</label>
      <input id="name" required />

      <label>Category</label>
      <input id="category" />

      <label>Code/SKU</label>
      <input id="sku" />

      <label>Rating *</label>
      <div class="rating">
        <input id="r1" type="radio" name="rating" value="1"><label for="r1">1</label>
        <input id="r2" type="radio" name="rating" value="2"><label for="r2">2</label>
        <input id="r3" type="radio" name="rating" value="3"><label for="r3">3</label>
        <input id="r4" type="radio" name="rating" value="4"><label for="r4">4</label>
        <input id="r5" type="radio" name="rating" value="5"><label for="r5">5</label>
      </div>

      <label>Photo <span class="muted">(optional)</span></label>
      <input id="photo" type="file" accept="image/*" />
      <img id="preview" class="preview" alt="preview" />

      <label>Notes</label>
      <textarea id="notes" rows="3"></textarea>

      <button type="submit">Save</button>
    </form>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h2 style="margin:0 0 8px">Your entries</h2>
      <div class="actions">
        <button type="button" id="exportCsv" class="btn-secondary" disabled>Export CSV</button>
        <button type="button" id="exportJson" class="btn-secondary" disabled>Export JSON (with photos)</button>
        <button type="button" id="exportZip" class="btn-secondary" disabled>Export ZIP (CSV + photos)</button>
      </div>
    </div>

    <!-- Mobile cards -->
    <div id="cards" class="cards"></div>

    <!-- Desktop table -->
    <div class="table-wrap">
      <table class="table" id="table"></table>
    </div>
  </div>

<script>
  /* ---------- Helpers ---------- */
  const $ = s => document.querySelector(s);
  function escapeHTML(s){return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
  function getRating(){ const r=document.querySelector('input[name="rating"]:checked'); return r?parseInt(r.value,10):0; }
  function safeFile(s){ return (s||'item').toLowerCase().replace(/[^a-z0-9._-]+/g,'-').slice(0,40); }

  /* ---------- Photo preview ---------- */
  $('#photo').addEventListener('change', e=>{
    const file=e.target.files?.[0], img=$('#preview');
    if(!file){ img.style.display='none'; delete img.dataset.dataurl; return; }
    const rd=new FileReader();
    rd.onload=ev=>{ img.src=ev.target.result; img.style.display='block'; img.dataset.dataurl=ev.target.result; };
    rd.readAsDataURL(file);
  });

  /* ---------- IndexedDB (no keyPath) ---------- */
  const DB_NAME='ProductRaterDB_v6'; const DB_VERSION=1;
  let db;
  function openDB(){
    return new Promise((resolve,reject)=>{
      const req=indexedDB.open(DB_NAME,DB_VERSION);
      req.onupgradeneeded=e=>{
        const db=e.target.result;
        if(db.objectStoreNames.contains('entries')) db.deleteObjectStore('entries');
        db.createObjectStore('entries',{autoIncrement:true});
      };
      req.onsuccess=e=>resolve(e.target.result);
      req.onerror=e=>reject(e.target.error);
    });
  }
  async function ensureDB(){ if(!db) db=await openDB(); return db; }
  async function addEntry(entry){
    await ensureDB();
    return new Promise((res,rej)=>{
      const tx=db.transaction('entries','readwrite');
      const req=tx.objectStore('entries').add(entry);
      req.onsuccess=()=>res();
      req.onerror =()=>rej(req.error);
    });
  }
  function getAllEntries(){
    return new Promise((res,rej)=>{
      const tx=db.transaction('entries','readonly');
      const req=tx.objectStore('entries').getAll();
      req.onsuccess=()=>res(req.result||[]);
      req.onerror =()=>rej(req.error);
    });
  }

  /* ---------- CSV Export ---------- */
  function csvEscape(v){
    const s = (v ?? '').toString().replace(/\r?\n/g,' ').replace(/"/g,'""');
    return `"${s}"`;
  }
  async function exportCSV(items){
    const header = ['Name','Category','SKU','Rating','Notes','Saved(ISO)'].map(csvEscape).join(',');
    const rows = items.map(it=>{
      return [
        csvEscape(it.name),
        csvEscape(it.category||''),
        csvEscape(it.sku||''),
        csvEscape(it.rating),
        csvEscape(it.notes||''),
        csvEscape(new Date(it.ts||Date.now()).toISOString())
      ].join(',');
    });
    const csv = [header, ...rows].join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `product_rater_${new Date().toISOString().s
