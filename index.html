<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ðŸ“¸ Product Rater</title>

<!-- PWA -->
<link rel="manifest" href="/Product-Research/manifest.webmanifest">
<link rel="icon" href="/Product-Research/icons/icon-192.png">
<link rel="apple-touch-icon" href="/Product-Research/icons/icon-192.png">
<meta name="theme-color" content="#0b1020">

<!-- ZIP builder (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  :root{--bg:#0b1020;--card:#111832;--mut:#aab3d4;--acc:#6ea8ff;--border:#223066;--gutter:18px}
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:auto;min-height:100dvh}
  body{
    font-family:Inter,Arial,sans-serif;background:var(--bg);color:#eef;margin:0;
    padding:20px;
    padding-left:max(20px,env(safe-area-inset-left));
    padding-right:max(20px,env(safe-area-inset-right));
    padding-bottom:max(20px,env(safe-area-inset-bottom));
    overflow-x:hidden;
  }
  h1{color:#8ec5ff;text-align:center;margin:0 0 16px}

  .card{
    background:#111832;border:1px solid var(--border);border-radius:16px;
    box-shadow:0 10px 30px rgba(10,18,45,.35);
    max-width:720px;margin:0 auto 16px;padding:var(--gutter) calc(var(--gutter) + 8px);
    overflow:visible;
  }

  #form{display:grid;gap:12px}
  label{font-weight:600;display:block}
  input,textarea,button{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
    background:#1b2444;color:#eef;
  }
  textarea{min-height:90px}
  button{background:#1a55ff;border:none;cursor:pointer}
  button:hover{background:#3a6eff}

  /* small secondary button */
  .btn-sm{width:auto;display:inline-block;padding:6px 10px;font-size:13px;border-radius:8px;
          background:#23306b;border:1px solid #3a4a86}
  .btn-sm:disabled{opacity:.6;cursor:not-allowed}

  .rating{display:grid;grid-template-columns:repeat(5,minmax(44px,1fr));gap:8px}
  .rating input{display:none}
  .rating label{background:#192040;text-align:center;padding:10px;border-radius:10px;cursor:pointer}
  .rating input:checked+label{background:#4473ff;color:#fff}

  .preview{width:120px;height:120px;object-fit:cover;border-radius:12px;border:1px solid var(--border);display:none}
  .thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;background:#0b132b}

  .muted{opacity:.8}

  .table-wrap{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:0 8px}
  .table{width:100%;border-collapse:collapse;table-layout:fixed}
  .table th,.table td{border-top:1px solid var(--border);padding:10px;text-align:left;vertical-align:top;word-wrap:break-word}
  .table th{color:#a9c7ff;font-weight:700}

  .toprow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}

  .cards{display:none;gap:10px}
  .entry-card{
    display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;
    background:#0c1330;border:1px solid var(--border);border-radius:14px;padding:10px
  }
  .entry-card .title{font-weight:700;color:#cfe1ff}
  .entry-card .meta{font-size:13px;color:#aab3d4}
  .entry-card .pill{display:inline-block;background:#1b2448;border:1px solid #2a386b;border-radius:999px;padding:2px 8px;font-size:12px;color:#cbd5ff;margin-right:6px}

  @media (max-width:640px){
    .table-wrap{display:none}
    .cards{display:grid}
  }
</style>
</head>
<body>
  <h1>ðŸ“¸ Product Rater</h1>

  <div class="card">
    <form id="form">
      <label>Product name *</label>
      <input id="name" required autocomplete="off" />

      <label>Category</label>
      <input id="category" autocomplete="off" />

      <label>Code/SKU</label>
      <input id="sku" autocomplete="off" />

      <label>Rating *</label>
      <div class="rating">
        <input id="r1" type="radio" name="rating" value="1"><label for="r1">1</label>
        <input id="r2" type="radio" name="rating" value="2"><label for="r2">2</label>
        <input id="r3" type="radio" name="rating" value="3"><label for="r3">3</label>
        <input id="r4" type="radio" name="rating" value="4"><label for="r4">4</label>
        <input id="r5" type="radio" name="rating" value="5"><label for="r5">5</label>
      </div>

      <label>Photo <span class="muted">(optional Â· auto-sized to a small square)</span></label>
      <input id="photo" type="file" accept="image/*" capture="environment" />
      <img id="preview" class="preview" alt="preview" />

      <label>Notes</label>
      <textarea id="notes" rows="3"></textarea>

      <button type="submit">Save</button>
    </form>
  </div>

  <div class="card">
    <div class="toprow">
      <h2 style="margin:0 0 8px">Your entries <span id="count" class="muted"></span></h2>
      <button id="exportZip" class="btn-sm" disabled>Export ZIP</button>
    </div>

    <!-- Mobile cards -->
    <div id="cards" class="cards"></div>

    <!-- Desktop table -->
    <div class="table-wrap">
      <table class="table" id="table"></table>
    </div>
  </div>

<script>
  /* ---------- Helpers ---------- */
  const $ = s => document.querySelector(s);
  function escapeHTML(s){return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
  function getRating(){ const r=document.querySelector('input[name="rating"]:checked'); return r?parseInt(r.value,10):0; }
  function safeFile(s){ return (s||'item').toLowerCase().replace(/[^a-z0-9._-]+/g,'-').slice(0,40); }

  /* ---------- Photo preview + compress to square 256px ---------- */
  const TARGET = 256;  // thumbnail size
  async function fileToSquareThumb(file){
    const img = await new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = () => { const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=fr.result; };
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
    const canvas = document.createElement('canvas');
    canvas.width = canvas.height = TARGET;
    const ctx = canvas.getContext('2d');
    // cover-fit crop to square
    const scale = Math.max(TARGET/img.width, TARGET/img.height);
    const w = img.width * scale, h = img.height * scale;
    const x = (TARGET - w)/2, y = (TARGET - h)/2;
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,TARGET,TARGET);
    ctx.drawImage(img, x, y, w, h);
    return canvas.toDataURL('image/jpeg', 0.8); // small, fast
  }

  $('#photo').addEventListener('change', async e=>{
    const file=e.target.files?.[0], img=$('#preview');
    if(!file){ img.style.display='none'; delete img.dataset.dataurl; return; }
    try{
      const thumb = await fileToSquareThumb(file);
      img.src = thumb; img.style.display='block'; img.dataset.dataurl = thumb;
    }catch{
      // fallback: show raw preview
      const fr = new FileReader();
      fr.onload = ev => { img.src = ev.target.result; img.style.display='block'; img.dataset.dataurl = ev.target.result; };
      fr.readAsDataURL(file);
    }
  });

  /* ---------- IndexedDB (clean) ---------- */
  const DB_NAME='ProductRaterDB_v8';
  const DB_VERSION=2;
  let db;
  function openDB(){
    return new Promise((resolve,reject)=>{
      const req=indexedDB.open(DB_NAME,DB_VERSION);
      req.onupgradeneeded=e=>{
        const db=e.target.result;
        if(!db.objectStoreNames.contains('entries')){
          db.createObjectStore('entries',{autoIncrement:true});
        }
      };
      req.onsuccess=e=>resolve(e.target.result);
      req.onerror=e=>reject(e.target.error);
    });
  }
  async function ensureDB(){ if(!db) db=await openDB(); return db; }
  async function addEntry(entry){
    await ensureDB();
    return new Promise((res,rej)=>{
      const tx=db.transaction('entries','readwrite');
      const store=tx.objectStore('entries');
      const req=store.add(entry);
      req.onsuccess=()=>res();
      req.onerror =()=>rej(req.error);
    });
  }
  async function getAllEntries(){
    await ensureDB();
    return new Promise((res,rej)=>{
      const tx=db.transaction('entries','readonly');
      const req=tx.objectStore('entries').getAll();
      req.onsuccess=()=>res(req.result||[]);
      req.onerror =()=>rej(req.error);
    });
  }

  /* ---------- Export ZIP (data.json + photos/) ---------- */
  async function exportZIP(items){
    if (!window.JSZip){ alert('ZIP library not loaded. Please go online once and try again.'); return; }
    const zip = new JSZip();

    const payload = { version: 2, exportedAt: new Date().toISOString(), items: [] };
    let photoIndex = 1;

    for (const it of items){
      const clean = {
        name: it.name || '',
        category: it.category || '',
        sku: it.sku || '',
        rating: it.rating || 0,
        notes: it.notes || '',
        ts: it.ts || Date.now(),
        photoFile: ''
      };
      if (it.photo){
        const m = it.photo.match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,(.+)$/);
        if (m){
          const mime = m[1];
          const b64  = m[2];
          const ext  = (mime.split('/')[1] || 'jpg').replace('jpeg','jpg');
          const fname = `${String(photoIndex).padStart(3,'0')}-${safeFile(it.name)}.${ext}`;
          zip.file(`photos/${fname}`, b64, { base64: true });
          clean.photoFile = `photos/${fname}`;
          photoIndex++;
        }
      }
      payload.items.push(clean);
    }

    zip.file('data.json', JSON.stringify(payload, null, 2));

    const blob = await zip.generateAsync({ type:'blob' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `product_rater_${new Date().toISOString().slice(0,10)}.zip`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  $('#exportZip').addEventListener('click', async () => {
    const items = (await getAllEntries()).sort((a,b)=> (b.ts||0)-(a.ts||0));
    if (!items.length) { alert('No entries to export.'); return; }
    exportZIP(items);
  });

  /* ---------- Render (mobile cards + desktop table) ---------- */
  async function render(){
    const items=(await getAllEntries()).sort((a,b)=> (b.ts||0)-(a.ts||0));
    $('#count').textContent = items.length ? `(${items.length})` : '';
    $('#exportZip').disabled = items.length === 0;

    // Mobile cards
    const cards=$('#cards');
    cards.innerHTML = items.map(it=>{
      const photo = it.photo
        ? `<img class="thumb" src="${it.photo}" alt="">`
        : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#9db0e0">â€“</div>`;
      return `<div class="entry-card">
        ${photo}
        <div>
          <div class="title">${escapeHTML(it.name)}</div>
          <div class="meta">
            <span class="pill">${escapeHTML(it.category||'No category')}</span>
            ${it.sku?`<span class="pill">SKU ${escapeHTML(it.sku)}</span>`:''}
          </div>
          <div class="meta">Rating: ${it.rating}/5</div>
          ${it.notes?`<div class="meta" style="margin-top:4px">${escapeHTML(it.notes)}</div>`:''}
          <div class="meta" style="margin-top:4px">${new Date(it.ts||Date.now()).toLocaleString()}</div>
        </div>
      </div>`;
    }).join('') || `<p class="muted">No entries yet.</p>`;

    // Desktop table
    const table=$('#table');
    if(!items.length){
      table.innerHTML = `<thead><tr><th>Photo</th><th>Name & Notes</th><th>Category</th><th>SKU</th><th>Rating</th><th>Saved</th></tr></thead><tbody></tbody>`;
      return;
    }
    const rows = items.map(it=>{
      const date=new Date(it.ts||Date.now()).toLocaleString();
      const photoCell=it.photo?`<img class="thumb" src="${it.photo}" alt="">`:`<span class="muted">â€”</span>`;
      return `<tr>
        <td>${photoCell}</td>
        <td><b>${escapeHTML(it.name)}</b><br><span class="muted">${escapeHTML(it.notes||'')}</span></td>
        <td>${escapeHTML(it.category||'â€”')}</td>
        <td>${escapeHTML(it.sku||'â€”')}</td>
        <td>${it.rating}/5</td>
        <td class="muted">${date}</td>
      </tr>`;
    }).join('');
    table.innerHTML = `<thead>
      <tr><th>Photo</th><th>Name & Notes</th><th>Category</th><th>SKU</th><th>Rating</th><th>Saved</th></tr>
    </thead><tbody>${rows}</tbody>`;
  }

  /* ---------- Save ---------- */
  $('#form').addEventListener('submit', async e=>{
    e.preventDefault();
    const name=$('#name').value.trim();
    const rating=getRating();
    if(!name||!rating){ alert('Please enter a product name and select a rating.'); return; }

    const entry={
      name,
      category: $('#category').value.trim(),
      sku: $('#sku').value.trim(),
      rating,
      notes: $('#notes').value.trim(),
      photo: $('#preview').dataset?.dataurl || '',  // already small thumbnail
      ts: Date.now()
    };

    try{
      await addEntry(entry);
      e.target.reset();
      const img=$('#preview'); img.style.display='none'; delete img.dataset.dataurl;
      await render();
      alert('âœ… Saved');
    }catch(err){
      console.error('Save failed:', err);
      alert('Save failed: '+(err?.message||err));
    }
  });

  (async()=>{ db=await openDB(); render(); })();

  /* ---------- PWA: register SW (bump to bust cache) ---------- */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/Product-Research/sw.js?v=13').catch(()=>{});
  }
</script>
</body>
</html>
